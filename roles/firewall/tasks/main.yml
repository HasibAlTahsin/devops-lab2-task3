---
- name: "Install ufw"
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: true
- name: "Allow required TCP ports (loop) - MUST run before enabling deny"
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop: "{{ allowed_tcp_ports }}"
  loop_control:
    label: "Allow TCP {{ item }}"
  notify: reload ufw
- name: "Enable UFW (idempotent)"
  community.general.ufw:
    state: enabled
  notify: reload ufw
- name: "Set default incoming policy to deny (after allow rules)"
  community.general.ufw:
    direction: incoming
    policy: deny
  notify: reload ufw
